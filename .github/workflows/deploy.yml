name: EventLive MVP Pipeline

on:
  push:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci || npm install

      - name: Run validation regression tests
        run: npm run test:validation

      - name: Run CSV parser regression tests
        run: npm run test:csv

      - name: Run release verdict regression tests
        run: npm run test:release-verdict

      - name: Run release verdict schema suite (positive + fail-closed negatives)
        run: npm run test:release-verdict-schema-suite

      - name: Restore schema suite runtime history cache
        uses: actions/cache/restore@v4
        with:
          path: ops/schema-suite-runtime-history.json
          key: schema-suite-history-${{ github.ref_name }}-${{ github.run_id }}
          restore-keys: |
            schema-suite-history-${{ github.ref_name }}-

      - name: Evaluate schema suite runtime regression trend (consecutive-run warning)
        run: npm run test:release-verdict-schema-regression

      - name: Publish schema runtime regression summary
        id: schema_regression_summary
        run: npm run report:release-verdict-schema-regression

      - name: Save schema suite runtime history cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ops/schema-suite-runtime-history.json
          key: schema-suite-history-${{ github.ref_name }}-${{ github.run_id }}

      - name: Validate data (with gate)
        run: npm run validate:gate

      - name: Build interactive HTML
        run: npm run build

      - name: Upload CI evidence bundle
        uses: actions/upload-artifact@v4
        with:
          name: ci-evidence-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: error
          path: |
            reports/*.md
            reports/*.json
            dist/index.html
            data/schema.json
            ops/schema-suite-runtime-history.json

      - name: Create status summary
        run: |
          echo "## EventLive Status Report" >> $GITHUB_STEP_SUMMARY
          echo "- Result: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "- Site (after deploy): https://${{ github.repository_owner }}.github.io/eventlive-sa/" >> $GITHUB_STEP_SUMMARY

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  verify-release:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci || npm install

      - name: Run post-deploy uptime check (retry x3)
        id: uptime
        continue-on-error: true
        env:
          EVENTLIVE_URL: https://${{ github.repository_owner }}.github.io/eventlive-sa/
          EVENTLIVE_MARKER: EventLive
        run: |
          attempts=3
          used_attempt=0
          for attempt in $(seq 1 $attempts); do
            used_attempt=$attempt
            echo "[uptime] attempt ${attempt}/${attempts}"
            if npm run uptime:check; then
              echo "[uptime] success on attempt ${attempt}"
              echo "attempts_used=${used_attempt}" >> "$GITHUB_OUTPUT"
              if [ "$used_attempt" -eq 1 ]; then
                echo "result_mode=first-pass" >> "$GITHUB_OUTPUT"
              else
                echo "result_mode=recovered-after-retry" >> "$GITHUB_OUTPUT"
              fi
              exit 0
            fi
            if [ "$attempt" -lt "$attempts" ]; then
              echo "[uptime] transient failure, retrying in 20s..."
              sleep 20
            fi
          done
          echo "attempts_used=${used_attempt}" >> "$GITHUB_OUTPUT"
          echo "result_mode=failed-after-retries" >> "$GITHUB_OUTPUT"
          echo "[uptime] failed after ${attempts} attempts"
          exit 1

      - name: Run post-deploy stability check (retry x3)
        id: stability
        continue-on-error: true
        env:
          EVENTLIVE_URL: https://${{ github.repository_owner }}.github.io/eventlive-sa/
          EVENTLIVE_MARKER: EventLive
          LATENCY_WARN_MS: 1200
          LATENCY_FAIL_MS: 2500
        run: |
          attempts=3
          used_attempt=0
          for attempt in $(seq 1 $attempts); do
            used_attempt=$attempt
            echo "[stability] attempt ${attempt}/${attempts}"
            if npm run stability:check; then
              echo "[stability] success on attempt ${attempt}"
              echo "attempts_used=${used_attempt}" >> "$GITHUB_OUTPUT"
              if [ "$used_attempt" -eq 1 ]; then
                echo "result_mode=first-pass" >> "$GITHUB_OUTPUT"
              else
                echo "result_mode=recovered-after-retry" >> "$GITHUB_OUTPUT"
              fi
              exit 0
            fi
            if [ "$attempt" -lt "$attempts" ]; then
              echo "[stability] transient failure, retrying in 30s..."
              sleep 30
            fi
          done
          echo "attempts_used=${used_attempt}" >> "$GITHUB_OUTPUT"
          echo "result_mode=failed-after-retries" >> "$GITHUB_OUTPUT"
          echo "[stability] failed after ${attempts} attempts"
          exit 1

      - name: Generate reliability rollup report
        if: always()
        env:
          ROLLUP_WINDOW_DAYS: 7
          MIN_SUCCESS_RATE_PCT: 99
          MAX_FAIL_RATE_PCT: 1
          UPTIME_OUTCOME: ${{ steps.uptime.outcome }}
          UPTIME_ATTEMPTS_USED: ${{ steps.uptime.outputs.attempts_used }}
          UPTIME_RESULT_MODE: ${{ steps.uptime.outputs.result_mode }}
          STABILITY_OUTCOME: ${{ steps.stability.outcome }}
          STABILITY_ATTEMPTS_USED: ${{ steps.stability.outputs.attempts_used }}
          STABILITY_RESULT_MODE: ${{ steps.stability.outputs.result_mode }}
        run: npm run reliability:rollup

      - name: Enforce rolling SLO policy gate
        id: slo_gate
        continue-on-error: true
        env:
          SLO_MIN_SAMPLES: 8
        run: npm run reliability:slo-gate

      - name: Upload release verification evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-verification-${{ github.run_id }}
          retention-days: 14
          if-no-files-found: warn
          path: |
            03-Reports/stability-24h-log.md
            04-Incidents/*.md
            reports/reliability-rollup.md

      - name: Compute release safety verdict
        if: always()
        id: release_verdict
        env:
          UPTIME_OUTCOME: ${{ steps.uptime.outcome }}
          STABILITY_OUTCOME: ${{ steps.stability.outcome }}
          SLO_OUTCOME: ${{ steps.slo_gate.outcome }}
          SLO_ENFORCEMENT_STATE: ${{ steps.slo_gate.outputs.enforcement_state || 'n/a' }}
          RELEASE_VERDICT_VALIDATE_SCHEMA: '1'
        run: npm run release:verdict

      - name: Create release scorecard summary
        if: always()
        run: |
          echo "## EventLive Release Scorecard" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy URL: https://${{ github.repository_owner }}.github.io/eventlive-sa/" >> $GITHUB_STEP_SUMMARY
          echo "- Release safety verdict: ${{ steps.release_verdict.outputs.verdict || 'ATTENTION' }} (${{ steps.release_verdict.outputs.verdict_reason || 'verdict unavailable' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Uptime check outcome: ${{ steps.uptime.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Uptime attempts used: ${{ steps.uptime.outputs.attempts_used || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Uptime result mode: ${{ steps.uptime.outputs.result_mode || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stability check outcome: ${{ steps.stability.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stability attempts used: ${{ steps.stability.outputs.attempts_used || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Stability result mode: ${{ steps.stability.outputs.result_mode || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Reliability rollup: reports/reliability-rollup.md (7-day window)" >> $GITHUB_STEP_SUMMARY
          echo "- SLO policy gate outcome: ${{ steps.slo_gate.outputs.policy_state || steps.slo_gate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- SLO enforcement mode: ${{ steps.slo_gate.outputs.enforcement_state || 'n/a' }}" >> $GITHUB_STEP_SUMMARY
          echo "- SLO policy hint: ${{ steps.slo_gate.outputs.enforcement_state == 'ACTIVE' && 'blocking gate active' || 'warm-up mode (non-blocking until sample minimum)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- SLO sample progress: ${{ steps.slo_gate.outputs.samples_progress || 'n/a' }} (min required: ${{ steps.slo_gate.outputs.samples_min || '8' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Evidence artifact: release-verification-${{ github.run_id }} (14 days)" >> $GITHUB_STEP_SUMMARY

      - name: Fail if release verification checks failed
        if: ${{ steps.uptime.outcome != 'success' || steps.stability.outcome != 'success' || steps.slo_gate.outcome != 'success' }}
        run: |
          echo "Release verification failed (uptime=${{ steps.uptime.outcome }}, stability=${{ steps.stability.outcome }}, slo_gate=${{ steps.slo_gate.outcome }})"
          exit 1
